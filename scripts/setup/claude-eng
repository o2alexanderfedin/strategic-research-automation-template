#!/bin/bash
# Claude CLI wrapper with engineering best practices system prompt
# Enables YOLO mode for fully autonomous operation
#
# This script:
# 1. Bypasses all permissions for unattended operation
# 2. Injects custom system prompts with engineering best practices
# 3. Enables all tools for maximum capability
# 4. Provides consistent command across different machines

set -e

# Enable verbose mode with --verbose flag
VERBOSE=false
if [[ "$*" == *"--verbose"* ]]; then
    VERBOSE=true
    # Remove --verbose from args to pass to claude
    set -- "${@/--verbose/}"
fi

# Find the system prompt file
# SCRIPT_DIR can be overridden for testing
if [ -z "$SCRIPT_DIR" ]; then
  SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
fi

SYSTEM_PROMPT_FILE="${SCRIPT_DIR}/.claude-system-prompt.md"

if [ ! -f "$SYSTEM_PROMPT_FILE" ]; then
    echo "Error: System prompt file not found at $SYSTEM_PROMPT_FILE" >&2
    exit 1
fi

if [ "$VERBOSE" = true ]; then
    echo "ðŸ”§ Claude Engineering Mode - YOLO Configuration"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ“ System prompt loaded: $SYSTEM_PROMPT_FILE"
fi

# Find claude executable
# Allow PATH override for testing
CLAUDE_EXEC="${CLAUDE_EXEC:-}"
if [ -z "$CLAUDE_EXEC" ]; then
  if [ -x "$HOME/.claude/local/claude" ]; then
    CLAUDE_EXEC="$HOME/.claude/local/claude"
  elif command -v claude &> /dev/null; then
    CLAUDE_EXEC="claude"
  else
    echo "Error: Claude CLI not found. Install from https://docs.claude.com" >&2
    exit 1
  fi
fi

if [ "$VERBOSE" = true ]; then
    echo "âœ“ Claude CLI found: $CLAUDE_EXEC"
    echo "âœ“ YOLO mode enabled: All permissions bypassed"
    echo "âœ“ Tools enabled: All (*)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸš€ Starting autonomous research execution..."
    echo ""
fi

# Execute claude with the system prompt and required permissions
# Redirect all output to stderr and disable buffering for real-time visibility
# Using stdbuf to force unbuffered output (line buffering for stdout/stderr)
# This ensures rookies see output immediately without waiting for buffer flush

# Check if stdbuf is available (most Linux/macOS systems have it via GNU coreutils)
if command -v stdbuf &> /dev/null; then
    # Use stdbuf for unbuffered output, redirect stdout to stderr for visibility
    exec stdbuf -oL -eL "$CLAUDE_EXEC" --append-system-prompt "$(cat "$SYSTEM_PROMPT_FILE")" \
        --allowedTools "*" \
        --dangerously-skip-permissions \
        --permission-mode "bypassPermissions" \
        "$@" 2>&1 >&2
else
    # Fallback: just redirect stdout to stderr without stdbuf
    exec "$CLAUDE_EXEC" --append-system-prompt "$(cat "$SYSTEM_PROMPT_FILE")" \
        --allowedTools "*" \
        --dangerously-skip-permissions \
        --permission-mode "bypassPermissions" \
        "$@" 2>&1 >&2
fi
